file:
  # Main config file includes other config files
  /opt/bitnami/apache/conf/httpd.conf:
    exists: true
    filetype: file
    contains:
      - /^Include.*\/opt\/bitnami\/apache\/conf\/bitnami\/bitnami.conf/
      - /^Include.*\/opt\/bitnami\/apache\/conf\/vhosts\/\*.conf/
      - /^Include.*\/opt\/bitnami\/apache\/conf\/deflate.conf/
  # Main bitnami config file was correctly generated in postunpack
  /opt/bitnami/apache/conf/bitnami/bitnami.conf:
    exists: true
    filetype: file
    contains:
      - /DocumentRoot.*\/opt\/bitnami\/apache\/htdocs/
      - /^Include.*\/opt\/bitnami\/apache\/conf\/bitnami\/bitnami-ssl.conf/
  # Main bitnami ssl config file was correctly generated in postunpack
  /opt/bitnami/apache/conf/bitnami/bitnami-ssl.conf:
    exists: true
    filetype: file
    contains:
      - "SSLProtocol all -SSLv2 -SSLv3"
      - /SSLCertificateFile.*bitnami\/certs\/server.crt/
      - /SSLCertificateKeyFile.*bitnami\/certs\/server.key/
  # CGI folder has been removed, as recommended by Apache
  /opt/bitnami/apache/cgi-bin:
    exists: false
  # Compiled disabled modules should have been generated
  {{ range $module := .Vars.modules.extra }}
  /opt/bitnami/apache/modules/mod_{{ $module }}.so:
    exists: true
    filetype: file
  {{ end }}
  # Modsecurity related files should be present
  /opt/bitnami/apache/conf/modsecurity.conf:
    exists: true
    filetype: file
  /opt/bitnami/apache/conf/unicode.mapping:
    exists: true
    filetype: file
command:
  # There are no syntax error in the configuration
  check-configuration:
    exec: apachectl -t
    exit-status: 0
  check-app-version:
    exec: apachectl -v
    exit-status: 0
    stdout:
      - {{ .Env.APP_VERSION }}
  # Check explicitly enabled and disable modules
  check-loaded-modules:
    exec: apachectl -M
    exit-status: 0
    stdout:
    {{ range $module := .Vars.modules.loaded }}
      - "{{ $module }}_module"
    {{ end }}
    {{ range $module := .Vars.modules.disabled }}
      - "!{{ $module }}_module"
    {{ end }}
  # Modules should not have references to broken libraries
  {{ range $module := (concat .Vars.modules.loaded .Vars.modules.disabled .Vars.modules.extra) }}
  broken-module-{{ $module }}:
    exec: ldd /opt/bitnami/apache/modules/mod_{{ $module }}.so
    exit-status: 0
    stdout:
      - "!not found"
  {{ end }}
